<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>旅遊領航員</title>
    
    <!-- PWA 與 iOS 設定 -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="旅遊領航員">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- 載入必要零件 (CDN) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 使用 Lucide 圖示庫 -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-[#F2E9E4]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // 圖示組件：確保 Lucide 圖示能正確渲染
        const Icon = ({ name, className = "w-6 h-6" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        function App() {
            const [image, setImage] = useState(null);
            const [status, setStatus] = useState('idle'); // idle, processing, result, error
            const [data, setData] = useState(null);
            const fileInputRef = useRef(null);
            const apiKey = ""; // 執行環境將自動提供 API Key

            // 指數退避 API 呼叫
            const callGemini = async (payload, retries = 5, delay = 1000) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('API Request Failed');
                    return await response.json();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return callGemini(payload, retries - 1, delay * 2);
                    }
                    throw error;
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImage(reader.result);
                        const base64 = reader.result.split(',')[1];
                        processImage(base64);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const processImage = async (base64) => {
                setStatus('processing');
                setData(null);

                const prompt = `
                    請作為「視覺通訊與消費情報專家」分析此圖。
                    
                    【菜單辨識邏輯】：
                    - 僅翻譯原圖可見文字。不加補充資訊、不加評價。所有價格轉為阿拉伯數字。

                    【商品辨識邏輯】：
                    - 識別品牌與品名。
                    - 彙整市場售價、特色、優缺點、社群評價。所有價格轉為阿拉伯數字。
                    - 重點：請將「特色」拆解為「短標題：簡短說明」的格式。

                    請以繁體中文回傳以下 JSON：
                    
                    1. 如果是「菜單」：
                    {
                        "type": "menu",
                        "title": "標題",
                        "sections": [{"category": "類別", "items": [{"name": "品名", "price": "數字", "note": "原文描述"}]}],
                        "summary": "一句話總結"
                    }

                    2. 如果是「商品外觀」：
                    {
                        "type": "product",
                        "name": "商品全名",
                        "brand": "品牌",
                        "priceRange": "售價區間 (如 NT$2,500 - 3,000)",
                        "userFeedback": {
                            "pros": ["簡短優點1", "簡短優點2"],
                            "cons": ["簡短注意事項1", "簡短注意事項2"]
                        },
                        "marketReview": "精煉的社群評價趨勢摘要",
                        "features": ["短標題：詳細說明", "短標題：詳細說明"],
                        "tagline": "一句話產品定位"
                    }
                `;

                try {
                    const result = await callGemini({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/png", data: base64 } }
                            ]
                        }],
                        generationConfig: { responseMimeType: "application/json" }
                    });

                    const parsedData = JSON.parse(result.candidates[0].content.parts[0].text);
                    setData(parsedData);
                    setStatus('result');
                } catch (error) {
                    console.error(error);
                    setStatus('error');
                }
            };

            const resetApp = () => {
                setImage(null);
                setStatus('idle');
                setData(null);
            };

            return (
                <div className="min-h-screen bg-[#F2E9E4] text-[#4A4E69] pb-12 transition-all">
                    {/* Header */}
                    <header className="p-6 flex justify-end items-center">
                        <div className="bg-white/60 backdrop-blur-md border border-[#C9ADA7]/30 rounded-full px-5 py-1.5 text-[10px] font-bold text-[#9A8C98] tracking-[0.2em] uppercase">
                            Travel Pilot AI
                        </div>
                    </header>

                    <main className="px-6 flex flex-col items-center justify-center min-h-[75vh]">
                        {status === 'idle' && (
                            <div className="text-center space-y-12 animate-in fade-in duration-700 w-full max-w-sm">
                                <div className="space-y-3">
                                    <h1 className="text-4xl font-black tracking-tight text-[#4A4E69] flex items-center justify-center gap-2">
                                        <Icon name="sparkles" className="w-7 h-7 text-[#C9ADA7]" />
                                        旅遊領航員
                                        <Icon name="sparkles" className="w-7 h-7 text-[#C9ADA7]" />
                                    </h1>
                                    <p className="text-[#9A8C98] text-sm font-medium tracking-wide">
                                        隨手拍下未知，開啟精彩旅程
                                    </p>
                                </div>

                                {/* 整合式按鈕區塊 */}
                                <div 
                                    onClick={() => fileInputRef.current.click()}
                                    className="flex flex-col items-center justify-center gap-6 p-10 rounded-[3rem] bg-white border-4 border-white shadow-[0_20px_50px_rgba(201,173,167,0.2)] hover:shadow-[0_25px_60px_rgba(201,173,167,0.3)] transition-all cursor-pointer group active:scale-[0.98]"
                                >
                                    <div className="w-24 h-24 rounded-full bg-[#F2E9E4] flex items-center justify-center group-hover:bg-[#C9ADA7]/20 transition-colors duration-500 shadow-inner">
                                        <Icon name="camera" className="w-10 h-10 text-[#C9ADA7]" />
                                    </div>
                                    <div className="space-y-2 text-center">
                                        <div className="bg-[#4A4E69] text-white px-10 py-4 rounded-2xl font-bold text-base shadow-md group-hover:bg-[#22223B] transition-colors">
                                            拍照或選取影像
                                        </div>
                                        <p className="text-[10px] text-[#9A8C98] font-bold uppercase tracking-widest opacity-60">
                                            Tap to Start Journey
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {status === 'processing' && (
                            <div className="flex flex-col items-center space-y-6 animate-pulse text-[#9A8C98]">
                                <Icon name="refresh-cw" className="w-10 h-10 animate-spin text-[#C9ADA7]" />
                                <p className="text-sm font-bold tracking-[0.3em] uppercase">正在導航搜尋中...</p>
                            </div>
                        )}

                        {status === 'result' && data && (
                            <div className="w-full max-w-md animate-in slide-in-from-bottom-8 duration-500">
                                <div className="bg-white rounded-[2.5rem] overflow-hidden shadow-2xl border border-white/50">
                                    <div className="relative h-48 overflow-hidden">
                                        <img src={image} className="w-full h-full object-cover opacity-90" />
                                        <div className="absolute inset-0 bg-gradient-to-t from-white via-transparent to-transparent"></div>
                                        <button onClick={resetApp} className="absolute top-4 right-4 bg-white/40 backdrop-blur-md text-[#4A4E69] p-2 rounded-full hover:bg-white transition-colors shadow-sm">
                                            <Icon name="x" className="w-4 h-4" />
                                        </button>
                                    </div>

                                    <div className="px-8 pb-10 -mt-8 relative z-10">
                                        {data.type === 'menu' ? (
                                            <div className="space-y-6">
                                                <div className="text-center space-y-1">
                                                    <div className="inline-flex items-center space-x-2 bg-[#F2E9E4] px-4 py-1.5 rounded-full mb-2 border border-white shadow-sm">
                                                        <Icon name="utensils-crossed" className="w-3 h-3 text-[#C9ADA7]" />
                                                        <span className="text-[10px] font-black text-[#9A8C98] tracking-widest uppercase">Direct Translation</span>
                                                    </div>
                                                    <h2 className="text-2xl font-black text-[#4A4E69]">{data.title}</h2>
                                                    <p className="text-xs italic text-[#9A8C98] font-medium">{data.summary}</p>
                                                </div>
                                                <div className="h-px bg-[#F2E9E4] w-full"></div>
                                                <div className="space-y-8 pt-2">
                                                    {data.sections?.map((section, idx) => (
                                                        <div key={idx} className="space-y-4">
                                                            <div className="flex items-center space-x-2 text-[#C9ADA7]">
                                                                <div className="w-1.5 h-3 bg-[#C9ADA7] rounded-full"></div>
                                                                <h4 className="text-[11px] font-black tracking-[0.2em] uppercase">{section.category}</h4>
                                                            </div>
                                                            <div className="space-y-4">
                                                                {section.items?.map((item, i) => (
                                                                    <div key={i} className="flex justify-between items-start">
                                                                        <div className="space-y-0.5 pr-4">
                                                                            <p className="text-sm font-bold text-[#4A4E69]">{item.name}</p>
                                                                            {item.note && <p className="text-[11px] text-[#9A8C98] italic font-medium">{item.note}</p>}
                                                                        </div>
                                                                        <div className="text-[11px] font-black text-[#C9ADA7] bg-[#F2E9E4]/50 px-2.5 py-1.5 rounded-xl border border-white shadow-sm">{item.price}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-7">
                                                <div className="text-center space-y-1">
                                                    <div className="inline-flex items-center space-x-2 bg-[#F2E9E4] px-4 py-1.5 rounded-full mb-2 border border-white shadow-sm">
                                                        <Icon name="shopping-bag" className="w-3 h-3 text-[#C9ADA7]" />
                                                        <span className="text-[10px] font-black text-[#9A8C98] tracking-widest uppercase">Discovery Detail</span>
                                                    </div>
                                                    <p className="text-[10px] font-bold text-[#C9ADA7] tracking-[0.3em] uppercase">{data.brand || "Global Brand"}</p>
                                                    <h2 className="text-2xl font-black text-[#4A4E69] leading-tight">{data.name}</h2>
                                                    <p className="text-xs italic text-[#9A8C98] font-medium opacity-80">{data.tagline}</p>
                                                </div>

                                                <div className="flex gap-3 justify-center">
                                                    <div className="flex items-center space-x-2 bg-[#F2E9E4]/60 px-5 py-2.5 rounded-2xl border border-white shadow-sm">
                                                        <Icon name="tag" className="w-4 h-4 text-[#C9ADA7]" />
                                                        <span className="text-xs font-black text-[#4A4E69]">{data.priceRange}</span>
                                                    </div>
                                                    <div className="flex items-center space-x-2 bg-[#F2E9E4]/60 px-5 py-2.5 rounded-2xl border border-white shadow-sm">
                                                        <Icon name="star" className="w-4 h-4 text-[#C9ADA7]" />
                                                        <span className="text-xs font-black text-[#4A4E69]">社群推薦</span>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-1 gap-4">
                                                    {data.features?.map((f, i) => (
                                                        <div key={i} className="flex items-start space-x-3 bg-[#F2E9E4]/20 p-4 rounded-2xl border border-white/50">
                                                            <Icon name="check" className="w-4 h-4 text-[#C9ADA7] mt-1 shrink-0" />
                                                            <p className="text-sm leading-relaxed text-[#4A4E69] font-medium">
                                                                {f.includes('：') ? (
                                                                    <><strong>{f.split('：')[0]}</strong>：{f.split('：')[1]}</>
                                                                ) : f}
                                                            </p>
                                                        </div>
                                                    ))}
                                                </div>

                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-[#9A8C98]/5 p-4 rounded-3xl border border-white shadow-sm">
                                                        <div className="flex items-center space-x-1.5 mb-2.5">
                                                            <Icon name="thumbs-up" className="w-3.5 h-3.5 text-[#C9ADA7]" />
                                                            <span className="text-[10px] font-black text-[#C9ADA7] uppercase tracking-wider">亮點清單</span>
                                                        </div>
                                                        <ul className="text-[11px] space-y-2 font-medium text-[#4A4E69]/80">
                                                            {data.userFeedback?.pros?.map((p, i) => <li key={i}>• {p}</li>)}
                                                        </ul>
                                                    </div>
                                                    <div className="bg-[#9A8C98]/5 p-4 rounded-3xl border border-white shadow-sm">
                                                        <div className="flex items-center space-x-1.5 mb-2.5">
                                                            <Icon name="alert-circle" className="w-3.5 h-3.5 text-[#9A8C98]" />
                                                            <span className="text-[10px] font-black text-[#9A8C98] uppercase tracking-wider">點評參考</span>
                                                        </div>
                                                        <ul className="text-[11px] space-y-2 font-medium text-[#4A4E69]/80">
                                                            {data.userFeedback?.cons?.map((c, i) => <li key={i}>• {c}</li>)}
                                                        </ul>
                                                    </div>
                                                </div>

                                                <div className="bg-white p-6 rounded-[2rem] border-2 border-[#F2E9E4] shadow-sm relative">
                                                    <Icon name="quote" className="absolute -top-3 -left-1 w-8 h-8 text-[#F2E9E4] opacity-50" />
                                                    <div className="flex items-center space-x-2 mb-3">
                                                        <Icon name="message-square" className="w-4 h-4 text-[#C9ADA7]" />
                                                        <span className="text-[10px] font-black tracking-[0.2em] text-[#C9ADA7] uppercase">社群輿情摘要</span>
                                                    </div>
                                                    <p className="text-sm leading-relaxed text-[#4A4E69] font-medium italic">
                                                        {data.marketReview}
                                                    </p>
                                                </div>
                                            </div>
                                        )}
                                        <button onClick={resetApp} className="w-full mt-10 bg-[#4A4E69] text-white py-4 rounded-2xl font-bold text-base hover:bg-[#22223B] transition-all shadow-lg active:scale-95">
                                            重新啟動導航
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {status === 'error' && (
                            <div className="bg-white p-10 rounded-[2.5rem] text-center space-y-6 shadow-xl border border-red-50 max-w-xs animate-in zoom-in duration-300">
                                <p className="text-[#9A8C98] font-bold text-sm leading-relaxed">辨識過程遇到一些困難，建議確保環境光線充足並盡量對焦文字。</p>
                                <button onClick={resetApp} className="bg-[#4A4E69] text-white px-8 py-3 rounded-full font-bold text-sm w-full shadow-md">重新出發</button>
                            </div>
                        )}
                    </main>

                    <footer className="fixed bottom-0 w-full p-8 flex flex-col items-center">
                        <p className="text-[9px] text-[#9A8C98] tracking-[0.4em] font-bold uppercase opacity-30">Global Vision Intelligence Pilot</p>
                    </footer>

                    <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
